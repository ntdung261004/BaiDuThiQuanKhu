{% extends "base.html" %}
{% block title %}Trang chủ{% endblock %}

{% block content %}
<div class="d-flex" id="wrapper">
    {% include 'sidebar.html' %}
    <div id="page-content-wrapper" style="width: 85%;">
        <nav class="navbar navbar-expand-lg navbar-light bg-light py-4 px-4">
            <div class="d-flex align-items-center">
                <h2 class="fs-2 m-0">Trang chủ</h2>
            </div>
            <div class="ms-auto">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle second-text fw-bold d-flex align-items-center" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <img id="navbar-avatar" 
                                src="{{ url_for('serve_user_data', filename=current_user.avatar_url) if current_user.avatar_url else url_for('static', filename='image/default_avatar.png') }}" 
                                 class="rounded-circle me-2" 
                                 width="30" height="30" 
                                 style="object-fit: cover;">
                            
                            <span id="navbar-greeting">
                                Chào, đồng chí {{ current_user.full_name.split()[-1] if current_user.full_name else current_user.username }}
                            </span>
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="{{ url_for('profile_page') }}">Hồ sơ cá nhân</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('logout') }}">Đăng xuất</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
        

        <div class="container-fluid px-4">
    
            <div class="row g-3 my-2">
                <div class="col-12">
                    <div class="p-4 bg-white shadow-sm rounded">
                        <h3 class="fs-3">Chào mừng đến với <br>Hệ thống Quản lý Thiết bị Tập luyện bắn súng ứng dụng camera AI DA01</h3>
                        <p class="text-muted">
                            Đây là thiết bị huấn luyện bắn súng thông minh, tích hợp trí tuệ nhân tạo và thuật toán xử lý ảnh để đánh giá chính xác kết quả.
                            Hệ thống quản lý theo dõi hiệu suất, thành tích cung cấp phân tích chuyên sâu và hỗ trợ người huấn luyện đưa ra phương pháp giúp bộ đội cải thiện đường ngắm dễ dàng,
                            đồng thời nâng cao tiêu chuẩn an toàn trong kiểm tra.
                        </p>
                    </div>
                </div>
            </div>
            <div class="row my-4">
                <h3 class="fs-4 mb-3">Chức năng chính của hệ thống</h3>
                <div class="col-12">
                    <ul class="list-group list-group-flush bg-white rounded shadow-sm">
                        <li class="list-group-item d-flex align-items-center">
                            <i class="fas fa-video me-3 text-primary"></i>
                            Phát Livestream đường ngắm từ AI camera thời gian thực
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <i class="fas fa-crosshairs me-3 text-primary"></i>
                            Phân tích, lưu trữ điểm số từng phát bắn tự động
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <i class="fas fa-chart-bar me-3 text-primary"></i>
                            Thống kê và báo cáo chi tiết kết quả bắn của từng buổi tập luyện, từng chiến sĩ
                        </li>
                    </ul>
                </div>
            </div>
            <div class="row g-3 my-2">
                <h3 class="fs-4 mb-3">Thông tin tổng quan đơn vị</h3>
                {% if current_user.is_profile_complete %}
                <div class="col-12">
                    <div class="p-3 bg-white shadow-sm d-flex justify-content-start align-items-center rounded">
                        <i class="fas fa-user-shield fs-1 text-success me-4"></i>
                        <div>
                            <h4 class="fs-5 mb-1">
                                <strong>Đơn vị:</strong> {{ current_user.unit }}
                            </h4>
                            <p class="fs-6 text-muted mb-0">
                                <strong>{{ current_user.position }} :</strong> {{ current_user.full_name }} | <strong>Cấp bậc:</strong> {{ current_user.rank }}
                            </p>
                        </div>
                    </div>
                </div>
                {% endif %}
                <div class="col-md-4">
                    <div class="p-3 bg-white shadow-sm d-flex justify-content-around align-items-center rounded">
                        <div>
                            <h3 class="fs-2">{{ total_soldiers }}</h3>
                            <p class="fs-5">Chiến sĩ</p>
                        </div>
                        <i class="fas fa-users fs-1 text-primary"></i>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="p-3 bg-white shadow-sm d-flex justify-content-around align-items-center rounded">
                        <div>
                            <h3 class="fs-2">{{ total_sessions }}</h3>
                            <p class="fs-5">Phiên tập</p>
                        </div>
                        <i class="fas fa-bullseye fs-1 text-secondary"></i>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="p-3 {% if is_system_active %}bg-success text-white{% else %}bg-white{% endif %} shadow-sm d-flex justify-content-around align-items-center rounded">
                        <div>
                            <h3 class="fs-2">
                                {% if is_system_active %}
                                    Hoạt động
                                {% else %}
                                    Sẵn sàng
                                {% endif %}
                            </h3>
                            <p class="fs-5">Hệ thống</p>
                        </div>
                        {% if is_system_active %}
                            <span class="spinner-border text-white" role="status" aria-hidden="true" style="width: 3rem; height: 3rem;"></span>
                        {% else %}
                            <i class="fas fa-power-off fs-1 text-info"></i>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="row g-3 my-2">
                <h3 class="fs-4 mb-3">Thao tác nhanh</h3>
                <div class="col-12">
                    <div class="p-4 bg-white shadow-sm rounded text-center">
                        <div class="row">
                            <div class="col-md-3 mb-2">
                                <a href="{{ url_for('training') }}" class="btn btn-primary btn-lg w-100">
                                    <i class="fas fa-bullseye me-2"></i>Thêm phiên tập
                                </a>
                            </div>
                            <div class="col-md-3 mb-2">
                                <button type="button" class="btn btn-success btn-lg w-100" data-bs-toggle="modal" data-bs-target="#addSoldierModal">
                                    <i class="fas fa-user-plus me-2"></i>Thêm chiến sĩ
                                </button>
                            </div>
                            <div class="col-md-3 mb-2">
                                <a href="{{ url_for('report') }}" class="btn btn-info btn-lg text-white w-100">
                                    <i class="fas fa-chart-line me-2"></i>Xem báo cáo
                                </a>
                            </div>
                            <div class="col-md-3 mb-2">
                                <a href="{{ url_for('profile_page') }}" class="btn btn-secondary btn-lg w-100">
                                    <i class="fas fa-user-edit me-2"></i>Sửa hồ sơ
                                </a>
                            </div>
                        </div>
                        </div>
                </div>
            </div>
            <div class="row my-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="fs-4">
                        Danh sách chiến sĩ
                        <span id="soldier-count" class="text-muted" style="font-size: 0.8em;">
                            (Tổng số: 0)
                        </span>
                    </h3>

                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="sort-button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-sort-amount-down me-2"></i>Sắp xếp theo
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="sort-button" id="sort-options">
                            <li><a class="dropdown-item" href="#" data-sortby="created_at" data-order="desc">Mới nhất</a></li>
                            <li><a class="dropdown-item" href="#" data-sortby="name" data-order="asc">Tên (A-Z)</a></li>
                            <li><a class="dropdown-item" href="#" data-sortby="name" data-order="desc">Tên (Z-A)</a></li>
                            <li><a class="dropdown-item" href="#" data-sortby="unit" data-order="asc">Đơn vị</a></li>
                            <li><a class="dropdown-item" href="#" data-sortby="rank" data-order="asc">Cấp bậc</a></li>
                        </ul>
                    </div>
                </div>
                <div class="p-3 bg-white shadow-sm rounded mb-3">
                    <form method="GET" action="{{ url_for('index') }}" class="row g-3 align-items-center " id="filter-form">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" name="search" placeholder="Tìm theo tên chiến sĩ..." value="{{ search_query }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-sitemap"></i></span>
                                <select class="form-select" name="unit">
                                    <option value="">-- Tất cả đơn vị --</option>
                                    {% for unit in unit_list %}
                                        <option value="{{ unit }}" {% if unit == unit_filter %}selected{% endif %}>{{ unit }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100">Lọc</button>
                        </div>
                    </form>
                </div>
                <div class="table-responsive">
                    <table class="table bg-white rounded shadow-sm table-hover table-soldiers">
                        <thead>
                            <tr>
                                <th scope="col" class="col-stt">#</th>
                                <th scope="col" class="col-name">Tên Chiến sĩ</th>
                                <th scope="col" class="col-unit">Đơn vị</th>
                                <th scope="col" class="col-rank">Cấp bậc</th>
                                <th scope="col" class="col-notes">Ghi chú</th>
                                <th scope="col" class="col-actions">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="soldier-tbody">
                            </tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-end mt-3">
                    <nav aria-label="Page navigation">
                        <ul class="pagination" id="pagination-controls">
                            </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

{% include 'partials/add_soldier_modal.html' %}
{% include 'partials/edit_soldier_modal.html' %}
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<script>
window.SOLDIER_API = {
  list: "{{ url_for('soldier_bp.get_soldiers') }}",
  create: "{{ url_for('soldier_bp.create_soldier') }}",
  update_template: "{{ url_for('soldier_bp.update_soldier', soldier_id=0) }}",
  delete_template: "{{ url_for('soldier_bp.delete_soldier', soldier_id=0) }}",
  count: "{{ url_for('soldier_bp.get_soldier_count') }}",
  report_template: "{{ url_for('report_page', report_type='soldier', report_id=0) }}"
};
</script>

<script src="{{ url_for('static', filename='js/soldiers.js') }}"></script>

{% endblock %}